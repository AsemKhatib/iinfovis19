<!-- HTML Content -->
<template>
    <div style="padding: 1rem;">
        <table class="calendar-nav">
            <thead>
                <tr>
                    <th class="all">all</th>
                    <th class="day" data-index="0">Mon</th>
                    <th class="day" data-index="1">Tue</th>
                    <th class="day" data-index="2">Wed</th>
                    <th class="day" data-index="3">Thu</th>
                    <th class="day" data-index="4">Fri</th>
                    <th class="day" data-index="5">Sat</th>
                    <th class="day" data-index="6">Sun</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="week" data-index="0">W 1</td>
                    <td class="single-day"><svg class="value" width="100%" viewBox="0 0 100 100"><circle cx="50" cy="50" r="0" fill="#f4c842ff" stroke="white" stroke-width="2"/></svg></td>
                    <td class="single-day"><svg class="value" width="100%" viewBox="0 0 100 100"><circle cx="50" cy="50" r="0" fill="#f4c842ff" stroke="white" stroke-width="2"/></svg></td>
                    <td class="single-day"><svg class="value" width="100%" viewBox="0 0 100 100"><circle cx="50" cy="50" r="0" fill="#f4c842ff" stroke="white" stroke-width="2"/></svg></td>
                    <td class="single-day"><svg class="value" width="100%" viewBox="0 0 100 100"><circle cx="50" cy="50" r="0" fill="#f4c842ff" stroke="white" stroke-width="2"/></svg></td>
                    <td class="single-day"><svg class="value" width="100%" viewBox="0 0 100 100"><circle cx="50" cy="50" r="0" fill="#f4c842ff" stroke="white" stroke-width="2"/></svg></td>
                    <td class="single-day"><svg class="value" width="100%" viewBox="0 0 100 100"><circle cx="50" cy="50" r="0" fill="#f4c842ff" stroke="white" stroke-width="2"/></svg></td>
                    <td class="single-day"><svg class="value" width="100%" viewBox="0 0 100 100"><circle cx="50" cy="50" r="0" fill="#f4c842ff" stroke="white" stroke-width="2"/></svg></td>
                </tr>
                <tr>
                    <td class="week" data-index="1">W 1</td>
                    <td class="single-day"><svg class="value" width="100%" viewBox="0 0 100 100"><circle cx="50" cy="50" r="0" fill="#f4c842ff" stroke="white" stroke-width="2"/></svg></td>
                    <td class="single-day"><svg class="value" width="100%" viewBox="0 0 100 100"><circle cx="50" cy="50" r="0" fill="#f4c842ff" stroke="white" stroke-width="2"/></svg></td>
                    <td class="single-day"><svg class="value" width="100%" viewBox="0 0 100 100"><circle cx="50" cy="50" r="0" fill="#f4c842ff" stroke="white" stroke-width="2"/></svg></td>
                    <td class="single-day"><svg class="value" width="100%" viewBox="0 0 100 100"><circle cx="50" cy="50" r="0" fill="#f4c842ff" stroke="white" stroke-width="2"/></svg></td>
                    <td class="single-day"><svg class="value" width="100%" viewBox="0 0 100 100"><circle cx="50" cy="50" r="0" fill="#f4c842ff" stroke="white" stroke-width="2"/></svg></td>
                    <td class="single-day"><svg class="value" width="100%" viewBox="0 0 100 100"><circle cx="50" cy="50" r="0" fill="#f4c842ff" stroke="white" stroke-width="2"/></svg></td>
                    <td class="single-day"><svg class="value" width="100%" viewBox="0 0 100 100"><circle cx="50" cy="50" r="0" fill="#f4c842ff" stroke="white" stroke-width="2"/></svg></td>
                </tr>
            </tbody>
        </table>
    </div>
</template>

<!-- Typescript content --> 
<script lang="ts">
import { Vue, Component, Prop, Watch } from "vue-property-decorator";
import * as SNAPSVG_TYPE from "snapsvg";

declare var Snap: typeof SNAPSVG_TYPE;

@Component
export default class PercentageCalendarNavigationComponent extends Vue {
    percentages: number[] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

    mounted() {
        this.$nextTick(function() {
            this.setupGestures();
            this.updatePercentages();
        });
    }

    updateHeadersEtcIvNecessary() {
        let indiciesSelected = [false, false, false, false, false, false, false, false, false, false, false, false, false, false];
        let cells = this.$el.querySelectorAll('.single-day');
        for ( var i = 0; i < cells.length; i++ ) {
            if ( cells[i].classList.contains("cell-selected") ) {
                indiciesSelected[i] = true;
            }
        }

        let days = this.$el.querySelectorAll('.day');
        for ( var i = 0; i < days.length; i++ ) {
            if ( indiciesSelected[i] && indiciesSelected[i+7] ) {
                days[i].classList.toggle('cell-selected', true);
            } else {
                days[i].classList.toggle('cell-selected', false);
            }
        }

        let weeks = this.$el.querySelectorAll('.week');
        for ( var i = 0; i < weeks.length; i++ ) {
            let counter = 0;
            for ( var j = 0; j < 7; j++ ) {
                if ( indiciesSelected[i*7+j] ) {
                    counter++;
                }
            }

            if ( counter == 7 ) {
                weeks[i].classList.toggle('cell-selected', true);
            } else {
                weeks[i].classList.toggle('cell-selected', false);
            }
        }
    }

    private setupGestures() {
        let comp = this;
        let days = this.$el.querySelectorAll('.day');
        let weeks = this.$el.querySelectorAll('.week');
        let cells = this.$el.querySelectorAll('.single-day');


        // Header days
        for ( var i = 0; i < days.length; i++ ) {
            days[i].addEventListener("click", function(event) {
                if ( event.target !== null ) {
                    let node = event.target as HTMLElement;
                    let index = parseInt(node.dataset.index as string);

                    if ( index !== null ) {
                        let has_a = cells[index].classList.contains("cell-selected");
                        let has_b = cells[index+7].classList.contains("cell-selected");
                        let semi_state = (has_a && !has_b) || (!has_a && has_b);

                        if ( semi_state ) {
                            cells[index].classList.toggle('cell-selected', true);
                            cells[index+7].classList.toggle('cell-selected', true);
                        } else {
                            cells[index].classList.toggle('cell-selected');
                            cells[index+7].classList.toggle('cell-selected');
                        }                        
                    }
                }
                comp.updateHeadersEtcIvNecessary();
            });
        }

        // Vertical header weeks
        for ( var i = 0; i < weeks.length; i++ ) {
            weeks[i].addEventListener("click", function(event) {
                if ( event.target !== null ) {
                    let node = event.target as HTMLElement;
                    let index = parseInt(node.dataset.index as string);

                    if ( index !== null ) {
                        let counter = 0;
                        for ( var j = 0; j < 7; j++ ) {
                            if ( cells[index*7+j].classList.contains("cell-selected") ) {
                                counter++;
                            }
                        }

                        let semi_state = counter != 7 && counter != 0;

                        for ( var j = 0; j < 7; j++ ) {
                            if ( semi_state ) {
                                cells[index*7+j].classList.toggle("cell-selected", true);
                            } else {
                                cells[index*7+j].classList.toggle("cell-selected");
                            }
                        }                   
                    }
                }
                comp.updateHeadersEtcIvNecessary();
            });
        }

        // Body cells
        for ( var i = 0; i < cells.length; i++ ) {
            cells[i].addEventListener("click", function(event) {
                if ( event.target !== null ) {
                    let td_cell = (event.target as HTMLElement).closest('.single-day');
                    if ( td_cell !== null ) {
                        td_cell.classList.toggle("cell-selected");
                    }
                }

                comp.updateHeadersEtcIvNecessary();
            });
        }
    }

    setPercentages(values: number[]) {
        if ( values === undefined ) {
            console.error("setPercentages must not be undefined");
            return;
        }

        if ( values.length != 14 ) {
            console.error("setPercentages values must be of length 14");
            return;
        }

        this.percentages = values;
        this.updatePercentages();
    }

    setPercentageAtIndex(index: number, value: number) {
        if ( index < 0 || index > 13 ) {
            console.error("setPercentageAtIndex: index must be 0-13");
            return;
        }
        console.log(this.percentages);
        this.percentages[index] = value;
        console.log(this.percentages);
        this.updatePercentages();
    }

    private updatePercentages() {
        let svgs = this.$el.querySelectorAll('.value');

        for ( var i = 0; i < this.percentages.length; i++ ) {
            let percentage = this.percentages[i];
            let radius = (percentage/1.0)*45;

            let snap = Snap((svgs[i] as SVGElement));
            let circle = snap.select('circle');
            circle.animate({r: radius}, 750);
        }
        
    }
}
</script>

<!-- (S)CSS content -->
<style>
    .calendar-nav {
        width: 100%;
        border-collapse: separate;
        border: 0.05rem solid #aaa;
        border-radius: 0.3rem;
        border-spacing: 0;
        border-bottom-left-radius: 0.3rem;
        border-bottom-right-radius: 0.3rem;
    }

    .calendar-nav thead {
        padding: 0;
        margin: 0;
    }

    .calendar-nav th {
        width: 12.495%;
        padding: 0;
        margin: 0;
        font-weight: normal !important;
        text-align: center;
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
        background-color: rgb(249, 29, 133, 0.0);
        transition: background-color 0.4s ease-out;
    }

    .calendar-nav th:hover {
        cursor: pointer;
    }

    .calendar-nav th.cell-selected {
        color: white !important;
    }

    .calendar-nav th {
        border-right: 0.05rem solid #aaa;
    }

    .calendar-nav th:last-of-type {
        border-right: none;
    }

    .calendar-nav td {
        padding: 0;
        margin: 0;
        width: 12.495%;
        border-top: 0.05rem solid #aaa;
        border-right: 0.05rem solid #aaa;
        background-color: rgb(249, 29, 133, 0.0);
        transition: background-color 0.4s ease-out;
        text-align: center;
    }

    .calendar-nav td.cell-selected {
        color: white !important;
    }

    .calendar-nav td:hover {
        cursor: pointer;
    }

    .calendar-nav td:last-of-type {
        border-right: none;
    }

    .cell-selected {
        background-color: rgb(249, 29, 133, 1.0) !important;
    }
</style>
